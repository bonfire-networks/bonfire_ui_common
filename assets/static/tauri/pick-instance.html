<!DOCTYPE html>
<html data-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>Bonfire</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #main, #main-iframe {
            width: 100%;
            height: 100vh;
            border: 0;
            overflow: visible;
        }
    </style>
</head>

<body>

<div id="main">
    <div id="loading" class="flex items-center justify-center h-screen">
        <span class="loading loading-spinner loading-lg"></span>
    </div>

    <div id="picker" style="display:none;" class="flex items-center justify-center h-screen">
        <form onsubmit="loadUrl()" class="card bg-base-200 shadow-xl w-full max-w-md">
            <div class="card-body items-center text-center gap-4">
                <h2 class="card-title text-2xl">Welcome to Bonfire</h2>
                <p class="text-base-content/70">Enter your username in the format <code class="kbd kbd-sm">@user@instance.domain</code></p>
                <input type="text" id="usernameInput" placeholder="@username@yourinstance.domain"
                    class="input input-bordered w-full" />
                <div class="card-actions w-full">
                    <button type="submit" class="btn btn-primary w-full">Log in</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- <script src="assets/iframe-modal.js"></script> -->
<script type="module">
    import {
        startLogin,
        handleLogin
    } from './assets/ap_c2s_client/js/activitypub/auth.js'

    // Load saved username on startup
    const saved = localStorage.getItem('appUsername') || localStorage.getItem('appUrl') || '';
    document.getElementById('usernameInput').value = saved;

    function getClientId() {
        let clientId = localStorage.getItem('appClientId');
        if (!clientId) {
            clientId = window.location.origin + '/client.jsonld';
            localStorage.setItem('appClientId', clientId);
        }
        return clientId;
    }

    function getRedirectUri() {
        return window.location.origin + '/pick-instance.html';
    }

    // Set WASM base path for Tauri (bundled resources served via asset protocol)
    if (window.__TAURI__) {
        localStorage.setItem('wasmBasePath', 'false');
        // localStorage.setItem('wasmBasePath', '/assets/openmls/');
    }

    function cleanup() {
        const keys = [
            'actor_id', 'appUsername', 'appUrl',
            'token_endpoint', 'authorization_endpoint', 'proxy_url',
            'access_token', 'appClientId', 'clientId', 'wasmBasePath'
        ];
        keys.forEach(k => localStorage.removeItem(k));
        sessionStorage.removeItem('code_verifier');
        sessionStorage.removeItem('state');
        console.log('[cleanup] Cleared auth/session keys');
    }
    window.cleanup = cleanup;

    function loggedIn() {
        const appUrl = localStorage.getItem('appUrl');

        console.log("Logged in, go to appUrl:", appUrl);

        if (!appUrl) return;

        // Update window title with username so multiple instances are distinguishable
        const username = localStorage.getItem('appUsername') || appUrl;
        if (window.__TAURI__) {
            window.__TAURI__.window.getCurrentWindow().setTitle(`Bonfire - ${username}`);
        }

        // Open the secure chat in a separate local Tauri window
        window.__TAURI__.core.invoke('open_secure_chat');

        // Start SSE notification listener
        window.__TAURI__.core.invoke('start_notifications', {
            instanceUrl: 'https://' + appUrl,
            token: localStorage.getItem('access_token')
        });

        // Navigate main window to the dashboard (top-level = cookies work)
        const dashboardUrl = URL.parse("/dashboard", 'https://' + appUrl);
        window.location.href = dashboardUrl;
    }

    // Handle logout action from tray menu or app-logout event
    if (window.location.hash === '#logout') {
        window.location.hash = '';
        cleanup();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('picker').style.display = 'block';
        document.getElementById('usernameInput').value = '';
    }
    // Handle OAuth callback (redirected back with ?code=...&state=...)
    else if (new URLSearchParams(window.location.search).get('code')) {
        try {
            await handleLogin({
                clientId: getClientId(),
                redirectUri: getRedirectUri()
            });
            console.log("OAuth login done");
            loggedIn();
        } catch (err) {
            console.error('[pick-instance] Token exchange failed:', err);
        }
    } else if (localStorage.getItem('access_token') && localStorage.getItem('appUrl')) {
        console.log("Already logged in from a previous session");
        loggedIn();
    } else {
        // Show the login form if not already logged in or in the middle of OAuth flow
        document.getElementById('loading').style.display = 'none';
        document.getElementById('picker').style.display = 'block';
    }

    // Login flow: resolve actor via webfinger, then redirect to OAuth authorize
    window.loadUrl = async function () {
        const input = document.getElementById('usernameInput').value.trim();
        if (!input) return;

        try {
            const url = await startLogin(input, getClientId(), getRedirectUri());
            window.location.href = url;
        } catch (err) {
            console.error('[pick-instance] Login error:', err);
            alert(err.message || 'Login failed');
        }
    }

</script>
</body>

</html>